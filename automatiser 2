âœ… Ã‰tapes dÃ©taillÃ©es pour dÃ©clencher une sauvegarde Ã  lâ€™arrÃªt dâ€™une VM dans Proxmox
ğŸ“ 1. CrÃ©e un rÃ©pertoire pour les hook scripts (si non existant)
bash
Copier
Modifier
mkdir -p /etc/pve/local/hooks
ğŸ“ 2. CrÃ©e ton hook script
Exemple : pour la VM ID 101, crÃ©e le fichier :

bash
Copier
Modifier
nano /etc/pve/local/hooks/vm101-hook.sh
Et colle ce contenu :

bash
Copier
Modifier
#!/bin/bash

# Hook script pour la VM 101

VMID="$1"
EVENT="$2"

if [ "$EVENT" == "post-stop" ]; then
    echo "[$(date)] La VM $VMID vient d'Ãªtre arrÃªtÃ©e. Lancement de la sauvegarde..." >> /var/log/hook_vm101.log
    vzdump $VMID --mode snapshot --compress zstd --storage local --remove 0 --quiet 1 >> /var/log/hook_vm101.log
    echo "[$(date)] Sauvegarde terminÃ©e pour la VM $VMID." >> /var/log/hook_vm101.log
fi
ğŸ” 3. Rends le script exÃ©cutable
bash
Copier
Modifier
chmod +x /etc/pve/local/hooks/vm101-hook.sh
âš™ï¸ 4. Associe le script Ã  ta VM via son fichier de configuration
Ã‰dite le fichier config de la VM (ex. VM ID 101) :

bash
Copier
Modifier
nano /etc/pve/qemu-server/101.conf
Ajoute Ã  la fin :

bash
Copier
Modifier
hookscript: local:hooks/vm101-hook.sh
âœ… 5. Test : arrÃªte la VM depuis lâ€™interface
Quand tu arrÃªtes la VM 101 depuis lâ€™interface ou en ligne de commande, le hook â€œpost-stopâ€ sera dÃ©clenchÃ©, et ta sauvegarde se lance automatiquement.

ğŸ“Œ RÃ©sumÃ© du comportement
Action	RÃ©sultat
VM arrÃªtÃ©e	Hook script lancÃ©
Script dÃ©tecte post-stop	Lancement automatique de la sauvegarde
Sauvegarde stockÃ©e	Dans /var/lib/vz/dump/ (par dÃ©faut)
Log de sauvegarde	/var/log/hook_vm101.log

ğŸ Bonus : Support multi-VM
Tu peux rÃ©utiliser le mÃªme script pour plusieurs VMs si tu veux un hook centralisÃ©. Il suffit de lâ€™attacher dans chaque *.conf :

bash
Copier
Modifier
hookscript: local:hooks/vm-hook.sh
Et dans le script, traite plusieurs IDs avec un case $VMID in).

Souhaites-tu que je :

Tâ€™Ã©crive un script pour plusieurs VMs ?

Ajoute un mail ou webhook de notification ?

Fasse la mÃªme chose pour les conteneurs LXC ?

Tu veux que je te prÃ©pare un pack complet Ã  copier/coller ?








